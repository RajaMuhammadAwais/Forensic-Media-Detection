name: Secure ignore and secrets automation

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/secure-ignore.yml"

jobs:
  ignore-and-untrack:
    name: Enforce .gitignore and untrack files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Ensure .gitignore entries
        shell: bash
        run: |
          set -euo pipefail
          touch .gitignore
          add_line() { grep -qxF "$1" .gitignore || echo "$1" >> .gitignore; }

          add_line ""
          add_line "# Secrets"
          add_line "secret.env"
          add_line "config.json"

          add_line ""
          add_line "# Logs"
          add_line "*.log"

          add_line ""
          add_line "# Node.js"
          add_line "node_modules/"

          add_line ""
          add_line "# Build"
          add_line "build/"

      - name: Untrack ignored files (if tracked)
        shell: bash
        run: |
          set -euo pipefail
          # Exact commands requested
          git rm --cached secret.env || true
          git rm --cached config.json || true
          git rm --cached -r build || true
          git rm --cached -r node_modules || true
          git rm --cached '*.log' || true

      - name: Commit and push changes (if any)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .gitignore || true
          if ! git diff --cached --quiet; then
            git commit -m "chore: ignore secrets, logs, build, and node_modules"
            git push
          else
            echo "No changes to commit."
          fi

  assume-unchanged:
    name: Alternate method (assume unchanged)
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Mark files as assume-unchanged (local-only effect)
        shell: bash
        run: |
          # Exact commands requested
          git update-index --assume-unchanged secret.env config.json || true

  git-secret:
    name: git-secret quickstart and encrypt
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Install git-secret and GnuPG
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y git-secret gnupg

      - name: Generate a GPG key (non-interactive) if none provided
        env:
          GPG_EMAIL: ${{ secrets.GPG_EMAIL || github.actor }}@users.noreply.github.com
        shell: bash
        run: |
          set -euo pipefail
          # If no keys exist, generate one non-interactively
          if ! gpg --list-keys >/dev/null 2>&1; then
            cat >key.conf <<'EOF'
%no-protection
Key-Type: default
Key-Length: 3072
Subkey-Type: default
Name-Real: GitHub Actions
Name-Email: ${GPG_EMAIL}
Expire-Date: 0
EOF
            gpg --batch --gen-key key.conf
          fi
          gpg --list-keys

      - name: Initialize git-secret, add user, add and encrypt secret file
        env:
          GPG_EMAIL: ${{ secrets.GPG_EMAIL || github.actor }}@users.noreply.github.com
        shell: bash
        run: |
          set -euo pipefail
          # Exact commands requested
          git secret init || true
          gpg --list-keys
          git secret tell "$GPG_EMAIL"
          touch secret.env
          git secret add secret.env
          git secret hide

      - name: Commit and push encrypted secrets
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add secret.env.secret .gitignore .gitsecret/keys/ || true
          if ! git diff --cached --quiet; then
            git commit -m "chore(secrets): add encrypted secret"
            git push
          else
            echo "No encrypted secret changes to commit."
          fi